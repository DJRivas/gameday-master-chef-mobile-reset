{% extends "base.html" %}
{% block content %}
<section id="rateCard" class="card">
  <h2>Rate an Appetizer <span class="ribbon">ğŸˆ LIVE</span></h2>
  <ul class="howto">
    <li><span>ğŸ˜‹</span><strong>Taste</strong> - 1: bland to 5: crave worthy</li>
    <li><span>ğŸ“¸</span><strong>Presentation</strong> - 1: sloppy to 5: Instagram worthy</li>
    <li><span>ğŸˆ</span><strong>Easy to Eat</strong> - 1: messy to 5: one hand, no fumbles</li>
  </ul>
  <p class="sub">Winner takes home the <strong>GOLDEN SPATULA ğŸ¥‡ğŸ³</strong>. Second and third get bragging rights only.</p>

  <form id="rateForm" class="grid">
    <label>Participant</label>
    <select name="entrant" id="entrant" required>
      <option value="" disabled selected>Select participant</option>
      {% for name in entrants %}<option value="{{ loop.index0 }}">{{ name }}</option>{% endfor %}
    </select>

    <div class="slider-wrap">
      <em>Taste</em>
      <input class="big-range" type="range" min="1" max="5" step="1" value="3" id="taste" />
      <div class="row"><span id="tasteEmoji" class="emoji">ğŸ™‚</span><span id="tasteScore" class="score-pill">3 / 5</span></div>
    </div>

    <div class="slider-wrap">
      <em>Presentation</em>
      <input class="big-range" type="range" min="1" max="5" step="1" value="3" id="presentation" />
      <div class="row"><span id="presEmoji" class="emoji">ğŸ™‚</span><span id="presScore" class="score-pill">3 / 5</span></div>
    </div>

    <div class="slider-wrap">
      <em>Easy to Eat</em>
      <input class="big-range" type="range" min="1" max="5" step="1" value="3" id="easy" />
      <div class="row"><span id="easyEmoji" class="emoji">ğŸ™‚</span><span id="easyScore" class="score-pill">3 / 5</span></div>
    </div>

    <label>(Optional) One word to describe it</label>
    <input type="text" id="one_word" placeholder="e.g., Elite" inputmode="text" />

    <label>(Optional) Your Name</label>
    <input type="text" id="judge" placeholder="e.g., Bryan" />

    <div class="row">
      <button class="btn" type="submit" id="submitBtn">Submit Rating</button>
    </div>
  </form>

  <div id="thanks" class="hidden">
    <p id="thanksMsg">Thanks for rating. You can update your score from this device any time.</p>
    <div class="row"><button class="btn" id="rateAnother" type="button">Rate or Update Another</button></div>
  </div>
</section>

<section id="resultsCard" class="card">
  <h2>Leaderboard <span class="ribbon">LIVE</span></h2>
  <div class="table-wrapper">
    <table class="table" id="resultsTable">
      <thead>
        <tr>
          <th>Rank</th><th>Participant</th><th>Votes</th>
          <th>Avg Taste</th><th>Avg Presentation</th><th>Avg Easy</th><th>Avg Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <p class="sub">Only the top chef takes home the <strong>GOLDEN SPATULA</strong>. Everyone else gets bragging rights.</p>

  <h3 style="margin-top:18px">One Word Results</h3>
  <div class="table-wrapper">
    <table class="table" id="wordsTable">
      <thead>
        <tr><th>Participant</th><th>Word</th><th>Count</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p class="sub"><a href="/words" style="color:#9bd4ff">Open the dedicated One Word page</a></p>
</section>
{% endblock %}

{% block scripts %}
<script>
  const tasteEmojis = {1:'ğŸ¤¢',2:'ğŸ˜–',3:'ğŸ™‚',4:'ğŸ˜‹',5:'ğŸ¤¤ğŸ”¥'};
  const presEmojis  = {1:'ğŸ™ˆ',2:'ğŸ˜¬',3:'ğŸ™‚',4:'ğŸ˜',5:'ğŸ¤©âœ¨'};
  const easyEmojis  = {1:'ğŸ¥´',2:'ğŸ˜•',3:'ğŸ™‚',4:'ğŸ‘',5:'ğŸˆğŸ‘Œ'};

  const entrant = document.getElementById('entrant');
  const taste = document.getElementById('taste');
  const presentation = document.getElementById('presentation');
  const easy = document.getElementById('easy');
  const judge = document.getElementById('judge');
  const oneWord = document.getElementById('one_word');
  const form = document.getElementById('rateForm');
  const thanks = document.getElementById('thanks');
  const thanksMsg = document.getElementById('thanksMsg');
  const submitBtn = document.getElementById('submitBtn');

  function syncEmoji(){
    const tv = +taste.value, pv = +presentation.value, ev = +easy.value;
    document.getElementById('tasteEmoji').textContent = tasteEmojis[tv];
    document.getElementById('presEmoji').textContent  = presEmojis[pv];
    document.getElementById('easyEmoji').textContent  = easyEmojis[ev];
    document.getElementById('tasteScore').textContent = `${tv} / 5`;
    document.getElementById('presScore').textContent  = `${pv} / 5`;
    document.getElementById('easyScore').textContent  = `${ev} / 5`;
  }
  ['input','change'].forEach(e => { taste.addEventListener(e, syncEmoji); presentation.addEventListener(e, syncEmoji); easy.addEventListener(e, syncEmoji); });
  syncEmoji();

  entrant.addEventListener('change', async () => {
    if (!entrant.value) return;
    try{
      const res = await fetch('/api/my-rating?entrant_index=' + encodeURIComponent(entrant.value));
      const data = await res.json();
      if (data.ok && data.rating){
        taste.value = data.rating.taste;
        presentation.value = data.rating.presentation;
        easy.value = data.rating.easy;
        judge.value = data.rating.judge || '';
        oneWord.value = data.rating.one_word || '';
        submitBtn.textContent = 'Update Rating';
        thanksMsg.textContent = 'Updated. Your score has been saved.';
      }else{
        taste.value = 3; presentation.value = 3; easy.value = 3; judge.value = ''; oneWord.value='';
        submitBtn.textContent = 'Submit Rating';
        thanksMsg.textContent = 'Thanks for rating. You can update your score from this device any time.';
      }
      syncEmoji();
    }catch{}
  });

  function sanitizeOneWord(s){
    if(!s) return null;
    const t = s.trim().split(/\s+/)[0].slice(0,20);
    return t || null;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!entrant.value) { alert('Please select a participant.'); return; }
    const payload = {
      entrant_index: +entrant.value,
      taste: +taste.value,
      presentation: +presentation.value,
      easy: +easy.value,
      one_word: sanitizeOneWord(oneWord.value),
      judge: judge.value || null
    };
    try{
      const res = await fetch('/api/rate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Failed');
      form.classList.add('hidden');
      thanks.classList.remove('hidden');
      refreshAll();
    }catch(err){ alert('Error: ' + err.message); }
  });

  document.getElementById('rateAnother')?.addEventListener('click', ()=>{
    thanks.classList.add('hidden'); form.classList.remove('hidden'); form.reset(); entrant.selectedIndex = 0;
    taste.value = 3; presentation.value = 3; easy.value = 3; judge.value=''; oneWord.value=''; submitBtn.textContent='Submit Rating'; syncEmoji();
  });

  async function refreshLeaderboard(){
    try{
      const res = await fetch('/api/leaderboard');
      const data = await res.json();
      const rows = [...data].sort((a,b)=> b.avg_total - a.avg_total);
      const trophy = (i)=> i===0? 'ğŸ†' : i===1? 'ğŸ¥ˆ' : i===2? 'ğŸ¥‰' : '';
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = rows.map((r,i)=>`
        <tr>
          <td class="medal" data-label="Rank">${trophy(i)}</td>
          <td data-label="Participant">${r.name}</td>
          <td data-label="Votes">${r.votes}</td>
          <td data-label="Avg Taste">${r.avg_taste.toFixed(2)}</td>
          <td data-label="Avg Presentation">${r.avg_presentation.toFixed(2)}</td>
          <td data-label="Avg Easy">${r.avg_easy.toFixed(2)}</td>
          <td data-label="Avg Total"><strong>${r.avg_total.toFixed(2)}</strong></td>
        </tr>`).join('');
    }catch{ /* ignore */ }
  }

  async function refreshWords(){
    try{
      const res = await fetch('/api/words');
      const data = await res.json();
      const tbody = document.querySelector('#wordsTable tbody');
      const rows = [];
      Object.keys(data).forEach(name => {
        (data[name] || []).forEach(item => {
          rows.push({ name, word: item.word, count: item.count });
        });
      });
      rows.sort((a,b)=> a.name.localeCompare(b.name) || b.count - a.count || a.word.localeCompare(b.word));
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td data-label="Participant">${r.name}</td>
          <td data-label="Word">${r.word}</td>
          <td data-label="Count">${r.count}</td>
        </tr>
      `).join('') || '<tr><td colspan="3" style="color:#9db0d0">No one word entries yet.</td></tr>';
    }catch{ /* ignore */ }
  }

  function refreshAll(){ refreshLeaderboard(); refreshWords(); }

  // Adaptive refresh
  let INTERVAL = 2000;
  let intervalId;
  function startAutoRefresh(){
    clearInterval(intervalId);
    intervalId = setInterval(refreshAll, INTERVAL);
  }
  document.addEventListener('visibilitychange', () => {
    INTERVAL = document.hidden ? 10000 : 2000;
    startAutoRefresh();
  });
  window.addEventListener('focus', refreshAll);
  window.addEventListener('online', refreshAll);

  refreshAll();
  startAutoRefresh();
</script>
{% endblock %}
